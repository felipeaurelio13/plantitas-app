import{a5 as p,a as h,u as j,E as m,r as x,j as e,n as y,m as b,a3 as u,aa as N,N as v,A as k}from"./index-S10IpQsS.js";import{u as w}from"./usePlantDetail-Ca-K2wj3.js";import{A as C}from"./index-DYDrsITg.js";import{H as S}from"./heart-CmRXjGO4.js";import{f as P,l as I,C as M,S as D,T as E}from"./TypingIndicator-BYdIlf2r.js";import{B as f,S as A}from"./Button-sPj853_b.js";import{I as H}from"./Input-5sD0LM7-.js";import"./useQuery-CKf0z--A.js";import"./eye-By5j0b1s.js";const z=()=>{const{plantId:t}=p(),r=h(),{user:i}=j(),n=m(o=>o.getPlantById(t||"")),a=m(o=>o.addChatMessage),s=m(o=>o.isLoading),l=x.useMemo(()=>{if(!n||!n.chatHistory||n.chatHistory.length===0)return!1;const o=n.chatHistory[n.chatHistory.length-1];return s&&o.sender==="user"},[n,s]);return{plant:n,isTyping:l,handleSendMessage:async o=>{if(!(!t||!i||!o.trim()))try{await a(t,o.trim(),i.id)}catch(g){console.error("Failed to send message:",g)}},handleGoBack:()=>{r(`/plant/${t}`)},currentUser:i}},R=({plant:t})=>{const r=h(),i=()=>{const n=t.healthScore/100,a=t.lastWatered?new Date(t.lastWatered).getTime():0,s=a?Math.max(0,1-(Date.now()-a)/(t.careProfile.wateringFrequency*24*60*60*1e3)):0,l=n*.6+s*.4;return l>.8?"radiante":l>.6?"feliz":l>.4?"estable":"necesitada de atención"};return e.jsx("header",{className:"sticky top-0 z-10 bg-background/80 backdrop-blur-sm border-b border-muted",children:e.jsxs("div",{className:"flex items-center gap-2 p-4 pt-safe-top",children:[e.jsx("button",{onClick:()=>r(y.toPlantDetail(t.id)),className:"btn btn-ghost btn-circle",children:e.jsx(C,{size:20})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"font-bold text-foreground truncate",children:t.nickname||t.name}),e.jsxs("p",{className:"text-xs text-neutral-600 dark:text-neutral-400 capitalize",children:["Se siente ",i()]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm font-semibold text-green-600 dark:text-green-400",children:[e.jsx(S,{className:"w-4 h-4"}),e.jsxs("span",{children:[t.healthScore,"%"]})]})]})})},B=t=>{switch(t){case"happy":case"excited":return"😊";case"grateful":return"🥰";case"worried":return"😟";case"sad":return"😢";default:return"🌱"}},L=({message:t})=>{var n,a;const r=t.sender==="user",i=s=>{N.success("¡Gracias por tu feedback!",s?"Nos alegra que la respuesta te haya sido útil.":"Trabajaremos para mejorar las respuestas.")};return e.jsxs(b.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},className:u("flex items-end gap-2",r?"justify-end":"justify-start"),children:[!r&&e.jsx("div",{className:"flex h-8 w-8 items-center justify-center rounded-full bg-muted text-xl",children:B(t.emotion)}),e.jsxs("div",{className:u("max-w-xs rounded-2xl px-4 py-2 sm:max-w-sm md:max-w-md shadow-adaptive",r?"rounded-br-lg bg-primary-700 text-white drop-shadow-sm":"rounded-bl-lg bg-contrast-surface text-contrast-medium border border-contrast","rounded-[12px]"),children:[e.jsx("p",{className:"text-sm",children:t.content}),((n=t.context)==null?void 0:n.insights)&&t.context.insights.length>0&&e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"font-semibold text-xs text-green-700 dark:text-green-300",children:"Recomendaciones y observaciones:"}),e.jsx("ul",{className:"space-y-1",children:t.context.insights.map((s,l)=>e.jsxs("li",{className:"text-xs bg-green-50 dark:bg-green-900/20 rounded-lg p-2 border border-green-200 dark:border-green-800",children:[e.jsxs("div",{className:"font-medium",children:[s.type==="warning"&&"⚠️ ",s.type==="tip"&&"💡 ",s.type==="recommendation"&&"🌱 ",s.type==="observation"&&"🔎 ",s.title]}),e.jsx("div",{children:s.description}),s.affectedPlants&&s.affectedPlants.length>0&&e.jsxs("div",{className:"mt-1 text-[11px] text-green-800 dark:text-green-200",children:["Plantas: ",s.affectedPlants.join(", ")]})]},l))})]}),((a=t.context)==null?void 0:a.suggestedActions)&&t.context.suggestedActions.length>0&&e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"font-semibold text-xs text-blue-700 dark:text-blue-300",children:"Acciones sugeridas:"}),e.jsx("ul",{className:"space-y-1",children:t.context.suggestedActions.map((s,l)=>e.jsxs("li",{className:"text-xs bg-blue-50 dark:bg-blue-900/20 rounded-lg p-2 border border-blue-200 dark:border-blue-800",children:[e.jsx("div",{className:"font-medium",children:s.action}),s.priority&&e.jsxs("div",{className:"text-[11px] text-blue-800 dark:text-blue-200",children:["Prioridad: ",s.priority]}),s.plantIds&&s.plantIds.length>0&&e.jsxs("div",{className:"text-[11px] text-blue-800 dark:text-blue-200",children:["Plantas: ",s.plantIds.join(", ")]})]},l))})]}),e.jsx("p",{className:u("mt-1 text-xs",r?"text-white/80":"text-contrast-soft","text-[#888] text-[12px]"),children:P(new Date(t.timestamp),{addSuffix:!0,locale:I})}),!r&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx("button",{"aria-label":"Respuesta útil",className:"text-green-600 hover:text-green-800 text-lg focus:outline-none",onClick:()=>i(!0),children:"👍"}),e.jsx("button",{"aria-label":"Respuesta no útil",className:"text-red-500 hover:text-red-700 text-lg focus:outline-none",onClick:()=>i(!1),children:"👎"})]})]})]})},T=({messages:t})=>e.jsx("div",{className:"space-y-4",children:t.map(r=>e.jsx(L,{message:r},r.id))}),F=["¿Cómo te sientes hoy?","¿Necesitas agua?","Cuéntame un dato curioso sobre ti"],q=({onSendMessage:t,isTyping:r})=>{const[i,n]=x.useState(""),a=x.useRef(null),s=()=>{var d;const c=(d=a.current)==null?void 0:d.value.trim();c&&(t(c),a.current&&(a.current.value=""))},l=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),s())};return e.jsx("footer",{className:"sticky bottom-0 z-10 bg-background/80 backdrop-blur-sm border-t border-border",children:e.jsxs("div",{className:"p-4 pb-safe-bottom space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(H,{type:"text",ref:a,onKeyDown:l,placeholder:"Escribe un mensaje...",className:"pr-12",disabled:r}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 text-muted-foreground",children:e.jsx(M,{size:16})})]}),e.jsx(f,{"aria-label":"Enviar mensaje",onClick:s,disabled:!i.trim()||r,size:"icon",children:e.jsx(D,{size:20})})]}),e.jsx("div",{className:"flex flex-wrap items-center gap-2 mb-3",children:F.map(c=>e.jsx(f,{onClick:()=>n(c),disabled:r,variant:"secondary",size:"sm",children:c},c))})]})})},G=({plantName:t})=>e.jsxs(b.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{duration:.5,ease:"easeOut"},className:"flex flex-1 flex-col items-center justify-center text-center p-8",children:[e.jsx("div",{className:"flex h-16 w-16 items-center justify-center rounded-full bg-primary/10 mb-4",children:e.jsx(A,{className:"h-8 w-8 text-primary"})}),e.jsx("h3",{className:"text-xl font-bold text-foreground",children:"Inicia una conversación"}),e.jsxs("p",{className:"text-muted-foreground max-w-xs",children:[t," está esperando para charlar. ¡Pregúntale sobre sus cuidados o simplemente saluda!"]})]}),Y=()=>{const{plantId:t}=p(),r=h(),{loading:i,error:n}=w(t),{plant:a,isTyping:s,handleSendMessage:l}=z(),c=x.useRef(null);return x.useEffect(()=>{var d;(d=c.current)==null||d.scrollIntoView({behavior:"smooth"})},[a==null?void 0:a.chatHistory,s]),i?e.jsxs("div",{className:"flex flex-col items-center justify-center h-screen bg-background text-foreground",children:[e.jsx(v,{className:"w-12 h-12 animate-spin text-green-500"}),e.jsx("p",{className:"mt-4 text-lg",children:"Cargando chat..."})]}):n?e.jsxs("div",{className:"flex flex-col items-center justify-center h-screen bg-background text-red-500",children:[e.jsxs("p",{className:"mb-4",children:["Error: ",n]}),e.jsx("button",{onClick:()=>r(-1),className:"btn btn-primary",children:"Volver"})]}):a?e.jsxs("div",{className:"flex flex-col h-screen bg-background text-foreground",children:[e.jsx(R,{plant:a}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",style:{paddingBottom:"calc(88px + env(safe-area-inset-bottom))"},children:[e.jsx(k,{children:a.chatHistory.length===0?e.jsx(G,{plantName:a.nickname||a.name}):e.jsx(T,{messages:a.chatHistory,plantNickname:a.nickname||a.name})}),s&&e.jsx(E,{}),e.jsx("div",{ref:c})]}),e.jsx(q,{onSendMessage:l,isTyping:s})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-screen bg-background text-foreground",children:[e.jsx("p",{className:"mb-4",children:"Planta no encontrada."}),e.jsx("button",{onClick:()=>r(-1),className:"btn btn-primary",children:"Volver"})]})};export{Y as default};
