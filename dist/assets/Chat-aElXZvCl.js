import{Z as p,a as h,u as j,E as x,r as l,j as e,n as y,m as g,W as u,a2 as N,N as v,A as k}from"./index-DJn3qQTM.js";import{u as w}from"./usePlantDetail-C6Cwi35q.js";import{A as C}from"./index-B-cOHYAm.js";import{H as S}from"./heart-C1po5BSB.js";import{f as M,l as D,C as E,S as H,T as I}from"./TypingIndicator-CTtDHrQg.js";import{B as f,S as P}from"./Button-CIBeVTkW.js";import{I as z}from"./Input-gtXZFX4H.js";import"./useQuery-B5n1QGWj.js";import"./eye-Bqpe03M5.js";const B=()=>{const{plantId:s}=p(),t=h(),{user:c}=j(),r=x(o=>o.getPlantById(s||"")),a=x(o=>o.addChatMessage),i=x(o=>o.isLoading),n=l.useMemo(()=>{if(!r||!r.chatHistory||r.chatHistory.length===0)return!1;const o=r.chatHistory[r.chatHistory.length-1];return i&&o.sender==="user"},[r,i]);return{plant:r,isTyping:n,handleSendMessage:async o=>{if(!(!s||!c||!o.trim()))try{await a(s,o.trim(),c.id)}catch(b){console.error("Failed to send message:",b)}},handleGoBack:()=>{t(`/plant/${s}`)},currentUser:c}},L=({plant:s})=>{const t=h(),c=()=>{const r=s.healthScore/100,a=s.lastWatered?new Date(s.lastWatered).getTime():0,i=a?Math.max(0,1-(Date.now()-a)/(s.careProfile.wateringFrequency*24*60*60*1e3)):0,n=r*.6+i*.4;return n>.8?"radiante":n>.6?"feliz":n>.4?"estable":"necesitada de atención"};return e.jsx("header",{className:"sticky top-0 z-10 bg-background/80 backdrop-blur-sm border-b border-muted",children:e.jsxs("div",{className:"flex items-center gap-2 p-4 pt-safe-top",children:[e.jsx("button",{onClick:()=>t(y.toPlantDetail(s.id)),className:"btn btn-ghost btn-circle",children:e.jsx(C,{size:20})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"font-bold text-foreground truncate",children:s.nickname||s.name}),e.jsxs("p",{className:"text-xs text-neutral-600 dark:text-neutral-400 capitalize",children:["Se siente ",c()]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm font-semibold text-green-600 dark:text-green-400",children:[e.jsx(S,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.healthScore,"%"]})]})]})})},A=s=>{switch(s){case"happy":case"excited":return"😊";case"grateful":return"🥰";case"worried":return"😟";case"sad":return"😢";default:return"🌱"}},T=({message:s})=>{const t=s.sender==="user",c=r=>{N.success("¡Gracias por tu feedback!",r?"Nos alegra que la respuesta te haya sido útil.":"Trabajaremos para mejorar las respuestas.")};return e.jsxs(g.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},className:u("flex items-end gap-2",t?"justify-end":"justify-start"),children:[!t&&e.jsx("div",{className:"flex h-8 w-8 items-center justify-center rounded-full bg-muted text-xl",children:A(s.emotion)}),e.jsxs("div",{className:u("max-w-xs rounded-2xl px-4 py-2 sm:max-w-sm md:max-w-md shadow-adaptive",t?"rounded-br-lg bg-primary text-white":"rounded-bl-lg bg-contrast-surface text-contrast-medium border border-contrast","rounded-[12px]"),children:[e.jsx("p",{className:"text-sm",children:s.content}),e.jsx("p",{className:u("mt-1 text-xs",t?"text-white/80":"text-contrast-soft","text-[#888] text-[12px]"),children:M(new Date(s.timestamp),{addSuffix:!0,locale:D})}),!t&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx("button",{"aria-label":"Respuesta útil",className:"text-green-600 hover:text-green-800 text-lg focus:outline-none",onClick:()=>c(!0),children:"👍"}),e.jsx("button",{"aria-label":"Respuesta no útil",className:"text-red-500 hover:text-red-700 text-lg focus:outline-none",onClick:()=>c(!1),children:"👎"})]})]})]})},F=({messages:s})=>e.jsx("div",{className:"space-y-4",children:s.map(t=>e.jsx(T,{message:t},t.id))}),R=["¿Cómo te sientes hoy?","¿Necesitas agua?","Cuéntame un dato curioso sobre ti"],W=({onSendMessage:s,isTyping:t})=>{const[c,r]=l.useState(""),a=()=>{c.trim()&&(s(c.trim()),r(""))},i=n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),a())};return e.jsx("footer",{className:"sticky bottom-0 z-10 bg-background/80 backdrop-blur-sm border-t border-border",children:e.jsxs("div",{className:"p-4 pb-safe-bottom space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(z,{type:"text",value:c,onChange:n=>r(n.target.value),onKeyDown:i,placeholder:"Escribe un mensaje...",className:"pr-12",disabled:t}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 text-muted-foreground",children:e.jsx(E,{size:16})})]}),e.jsx(f,{"aria-label":"Enviar mensaje",onClick:a,disabled:!c.trim()||t,size:"icon",children:e.jsx(H,{size:20})})]}),e.jsx("div",{className:"flex flex-wrap items-center gap-2 mb-3",children:R.map(n=>e.jsx(f,{onClick:()=>r(n),disabled:t,variant:"secondary",size:"sm",children:n},n))})]})})},q=({plantName:s})=>e.jsxs(g.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{duration:.5,ease:"easeOut"},className:"flex flex-1 flex-col items-center justify-center text-center p-8",children:[e.jsx("div",{className:"flex h-16 w-16 items-center justify-center rounded-full bg-primary/10 mb-4",children:e.jsx(P,{className:"h-8 w-8 text-primary"})}),e.jsx("h3",{className:"text-xl font-bold text-foreground",children:"Inicia una conversación"}),e.jsxs("p",{className:"text-muted-foreground max-w-xs",children:[s," está esperando para charlar. ¡Pregúntale sobre sus cuidados o simplemente saluda!"]})]}),X=()=>{const{plantId:s}=p(),t=h(),{loading:c,error:r}=w(s),{plant:a,isTyping:i,handleSendMessage:n}=B(),d=l.useRef(null);return l.useEffect(()=>{var m;(m=d.current)==null||m.scrollIntoView({behavior:"smooth"})},[a==null?void 0:a.chatHistory,i]),c?e.jsxs("div",{className:"flex flex-col items-center justify-center h-screen bg-background text-foreground",children:[e.jsx(v,{className:"w-12 h-12 animate-spin text-green-500"}),e.jsx("p",{className:"mt-4 text-lg",children:"Cargando chat..."})]}):r?e.jsxs("div",{className:"flex flex-col items-center justify-center h-screen bg-background text-red-500",children:[e.jsxs("p",{className:"mb-4",children:["Error: ",r]}),e.jsx("button",{onClick:()=>t(-1),className:"btn btn-primary",children:"Volver"})]}):a?e.jsxs("div",{className:"flex flex-col h-screen bg-background text-foreground",children:[e.jsx(L,{plant:a}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",style:{paddingBottom:"calc(88px + env(safe-area-inset-bottom))"},children:[e.jsx(k,{children:a.chatHistory.length===0?e.jsx(q,{plantName:a.nickname||a.name}):e.jsx(F,{messages:a.chatHistory,plantNickname:a.nickname||a.name})}),i&&e.jsx(I,{}),e.jsx("div",{ref:d})]}),e.jsx(W,{onSendMessage:n,isTyping:i})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-screen bg-background text-foreground",children:[e.jsx("p",{className:"mb-4",children:"Planta no encontrada."}),e.jsx("button",{onClick:()=>t(-1),className:"btn btn-primary",children:"Volver"})]})};export{X as default};
