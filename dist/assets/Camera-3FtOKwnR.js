import{c as z,r as c,a as E,j as e,k as S,m as w,C as I,t as A}from"./index-fgwvdg1Q.js";import{u as F}from"./usePlantMutations-B3kCEckf.js";import{B as u,A as P}from"./Button-C0b7_Urf.js";import{C as M}from"./circle-alert-B474iQcT.js";import{S as T}from"./sparkles-y0snA4dw.js";import{I as G}from"./image-LfgNNn32.js";/**
 * @license lucide-react v0.411.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const L=z("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);/**
 * @license lucide-react v0.411.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const D=z("Slash",[["path",{d:"M22 2 2 22",key:"y4kqgn"}]]);/**
 * @license lucide-react v0.411.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=z("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]),U=({videoRef:s,canvasRef:t})=>{const[o,d]=c.useState(!1),[f,h]=c.useState(null),[m,p]=c.useState("environment"),[y,j]=c.useState(null),n=c.useRef(null),x=c.useCallback(async()=>{try{n.current&&n.current.getTracks().forEach(l=>l.stop()),j(null);const a=await navigator.mediaDevices.getUserMedia({video:{facingMode:m,width:{ideal:1920},height:{ideal:1080},aspectRatio:16/9}});s.current&&(s.current.srcObject=a,n.current=a)}catch(a){console.error("Error accessing camera:",a),a instanceof Error?a.name==="NotAllowedError"||a.message.includes("Permission dismissed")?j("Permiso de cámara denegado. Por favor, actívalo en los ajustes de tu navegador."):j("No se pudo acceder a la cámara. Revisa los permisos y el dispositivo."):j("Ocurrió un error inesperado al acceder a la cámara.")}},[m,s]);c.useEffect(()=>(x(),()=>{n.current&&n.current.getTracks().forEach(a=>a.stop())}),[x]);const C=c.useCallback(()=>{if(!s.current||!t.current)return;const a=s.current,l=t.current,b=l.getContext("2d");if(!b)return;l.width=a.videoWidth,l.height=a.videoHeight,b.drawImage(a,0,0,a.videoWidth,a.videoHeight);const i=l.toDataURL("image/jpeg",.9);h(i),d(!0),n.current&&n.current.getTracks().forEach(r=>r.stop()),"vibrate"in navigator&&navigator.vibrate(50)},[s,t]),N=c.useCallback(()=>{h(null),d(!1),x()},[x]);return{isCapturing:o,capturedImage:f,cameraError:y,captureImage:C,retakePhoto:N,switchCamera:()=>{p(a=>a==="user"?"environment":"user")},startCamera:x,selectFromGallery:a=>{if(a&&a.type.startsWith("image/")){const l=new FileReader;l.onload=b=>{var r;const i=(r=b.target)==null?void 0:r.result;h(i),d(!0),n.current&&n.current.getTracks().forEach(v=>v.stop())},l.readAsDataURL(a)}}}},$=({error:s,onRetry:t})=>{const o=E();return e.jsx("div",{className:"absolute inset-0 bg-black flex items-center justify-center p-6",children:e.jsx("div",{className:"bg-gray-900 rounded-2xl p-6 max-w-sm w-full mx-4",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mb-4",children:e.jsx(M,{size:32,className:"text-red-400"})}),e.jsx("h3",{className:"text-white text-lg font-semibold mb-2",children:"Camera Access Required"}),e.jsx("p",{className:"text-gray-300 text-sm mb-6 leading-relaxed",children:s}),e.jsxs("div",{className:"space-y-3 w-full",children:[e.jsxs(u,{onClick:t,children:[e.jsx(S,{size:18,className:"mr-2"}),e.jsx("span",{children:"Try Again"})]}),e.jsx(u,{onClick:()=>o("/"),variant:"secondary",children:"Go Back"})]}),e.jsx("div",{className:"mt-4 p-3 bg-gray-800 rounded-lg",children:e.jsxs("p",{className:"text-gray-400 text-xs",children:[e.jsx("strong",{children:"How to enable camera:"}),e.jsx("br",{}),"1. Click the camera icon in your browser's address bar",e.jsx("br",{}),'2. Select "Allow" for camera access',e.jsx("br",{}),'3. Refresh the page or tap "Try Again"']})})]})})})},q=({image:s,isAnalyzing:t,onRetake:o,onAnalyze:d})=>e.jsxs(e.Fragment,{children:[e.jsx(w.img,{src:s,alt:"Captured plant",className:"absolute inset-0 w-full h-full object-cover z-10",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0}}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-8 safe-area-bottom z-20",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-6",children:[e.jsx(u,{onClick:o,variant:"secondary",disabled:t,children:"Retake"}),e.jsx(u,{onClick:d,disabled:t,children:t?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Analyzing..."})]}):"Add Plant"})]}),t&&e.jsx("p",{className:"text-center text-white mt-4 text-sm",children:"AI is identifying your plant and creating a care profile..."})]})]}),B=({videoRef:s,canvasRef:t,flashEnabled:o,onCapture:d,onSwitchCamera:f,onToggleFlash:h,onSelectFromGallery:m})=>{const p=E();return e.jsxs(e.Fragment,{children:[e.jsx(w.video,{ref:s,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover",initial:{opacity:0},animate:{opacity:1},transition:{duration:.5}}),e.jsx("canvas",{ref:t,className:"hidden"}),e.jsx("div",{className:"absolute top-0 left-0 right-0 p-4 safe-area-top z-20",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(u,{onClick:()=>p("/"),variant:"ghost",size:"icon",className:"rounded-full bg-black/50",children:e.jsx(H,{size:20})}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(u,{onClick:h,variant:"ghost",size:"icon",className:`rounded-full ${o?"bg-yellow-500 text-black hover:bg-yellow-600":"bg-black/50"}`,children:o?e.jsx(T,{size:20}):e.jsx(D,{size:20})}),e.jsx(u,{onClick:f,variant:"ghost",size:"icon",className:"rounded-full bg-black/50",children:e.jsx(L,{size:20})})]})]})}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-8 safe-area-bottom z-20",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-8",children:[e.jsx(u,{onClick:m,size:"icon",variant:"ghost",className:"w-14 h-14 rounded-full bg-black/50",children:e.jsx(G,{size:24})}),e.jsx(w.button,{onClick:d,className:"w-20 h-20 rounded-full bg-white border-4 border-gray-300 flex items-center justify-center ios-button",whileHover:{scale:1.05},whileTap:{scale:.95},children:e.jsx("div",{className:"w-16 h-16 rounded-full bg-white flex items-center justify-center",children:e.jsx(I,{size:24,className:"text-gray-600"})})}),e.jsx("div",{className:"w-14 h-14"})]}),e.jsx("p",{className:"text-center text-white mt-4 text-sm",children:"Position your plant in the frame and tap to capture, or select from gallery"})]}),e.jsx("div",{className:"absolute inset-0 pointer-events-none flex items-center justify-center",children:e.jsx("div",{className:"w-64 h-64 border-2 border-white/50 rounded-2xl"})})]})},Q=()=>{const s=E(),{createPlant:t,isCreatingPlant:o}=F(),d=c.useRef(null),f=c.useRef(null),{isCapturing:h,capturedImage:m,cameraError:p,captureImage:y,retakePhoto:j,switchCamera:n,startCamera:x,selectFromGallery:C}=U({videoRef:d,canvasRef:f}),[N,R]=c.useState(!1),k=c.useRef(null),a=()=>{if(!m)return;const i=new Promise((r,v)=>{t(m,{onSuccess:g=>{g!=null&&g.id?s(`/plant/${g.id}`):s("/"),r(g)},onError:g=>{v(g)}})});A.promise(i,{loading:"Analizando imagen... La IA está trabajando.",success:r=>`¡Planta "${r.name}" creada con éxito!`,error:r=>`Error: ${r.message}`})},l=()=>R(i=>!i),b=i=>{var v;const r=(v=i.target.files)==null?void 0:v[0];r&&C(r)};return e.jsxs("div",{className:"fixed inset-0 bg-black z-50",children:[e.jsx("input",{ref:k,type:"file",accept:"image/*",onChange:b,className:"hidden",id:"gallery-input"}),e.jsx(P,{mode:"wait",children:p?e.jsx($,{error:p,onRetry:x},"error"):h?e.jsx(q,{image:m,isAnalyzing:o,onRetake:j,onAnalyze:a},"preview"):e.jsx(B,{videoRef:d,canvasRef:f,flashEnabled:N,onCapture:y,onSwitchCamera:n,onToggleFlash:l,onSelectFromGallery:()=>{var i;return(i=k.current)==null?void 0:i.click()}},"capture")})]})};export{Q as default};
