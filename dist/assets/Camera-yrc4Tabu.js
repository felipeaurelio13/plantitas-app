import{B as R,r,a as z,j as e,O as I,S as A,m as k,X as F,A as P,t as T}from"./index-BVChhxiE.js";import{I as M,C as D,u as G}from"./usePlantMutations-D60ZUXI6.js";import{B as h,S as L}from"./Button-Dc5vwy09.js";/**
 * @license lucide-react v0.411.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=R("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);/**
 * @license lucide-react v0.411.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=R("Slash",[["path",{d:"M22 2 2 22",key:"y4kqgn"}]]),H=({videoRef:s,canvasRef:t})=>{const[l,o]=r.useState(!1),[p,x]=r.useState(null),[u,j]=r.useState("environment"),[y,b]=r.useState(null),n=r.useRef(null),g=r.useCallback(async()=>{try{n.current&&n.current.getTracks().forEach(i=>i.stop()),b(null);const a=await navigator.mediaDevices.getUserMedia({video:{facingMode:u,width:{ideal:1920},height:{ideal:1080},aspectRatio:16/9}});s.current&&(s.current.srcObject=a,n.current=a)}catch(a){console.error("Error accessing camera:",a),a instanceof Error?a.name==="NotAllowedError"||a.message.includes("Permission dismissed")?b("Permiso de cámara denegado. Por favor, actívalo en los ajustes de tu navegador."):b("No se pudo acceder a la cámara. Revisa los permisos y el dispositivo."):b("Ocurrió un error inesperado al acceder a la cámara.")}},[u,s]);r.useEffect(()=>(g(),()=>{n.current&&n.current.getTracks().forEach(a=>a.stop())}),[g]);const C=r.useCallback(()=>{if(!s.current||!t.current)return;const a=s.current,i=t.current,v=i.getContext("2d");if(!v)return;i.width=a.videoWidth,i.height=a.videoHeight,v.drawImage(a,0,0,a.videoWidth,a.videoHeight);const c=i.toDataURL("image/jpeg",.9);x(c),o(!0),n.current&&n.current.getTracks().forEach(m=>m.stop()),"vibrate"in navigator&&navigator.vibrate(50)},[s,t]),N=r.useCallback(()=>{x(null),o(!1),g()},[g]);return{isCapturing:l,capturedImage:p,cameraError:y,captureImage:C,retakePhoto:N,switchCamera:()=>{j(a=>a==="user"?"environment":"user")},startCamera:g,selectFromGallery:a=>{if(a&&a.type.startsWith("image/")){const i=new FileReader;i.onload=v=>{var m;const c=(m=v.target)==null?void 0:m.result;x(c),o(!0),n.current&&n.current.getTracks().forEach(d=>d.stop())},i.readAsDataURL(a)}}}},$=({error:s,onRetry:t})=>{const l=z();return e.jsx("div",{className:"absolute inset-0 bg-black flex items-center justify-center p-6",children:e.jsx("div",{className:"bg-gray-900 rounded-2xl p-6 max-w-sm w-full mx-4",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mb-4",children:e.jsx(I,{size:32,className:"text-red-400"})}),e.jsx("h3",{className:"text-white text-lg font-semibold mb-2",children:"Camera Access Required"}),e.jsx("p",{className:"text-gray-300 text-sm mb-6 leading-relaxed",children:s}),e.jsxs("div",{className:"space-y-3 w-full",children:[e.jsxs(h,{onClick:t,children:[e.jsx(A,{size:18,className:"mr-2"}),e.jsx("span",{children:"Try Again"})]}),e.jsx(h,{onClick:()=>l("/"),variant:"secondary",children:"Go Back"})]}),e.jsx("div",{className:"mt-4 p-3 bg-gray-800 rounded-lg",children:e.jsxs("p",{className:"text-gray-400 text-xs",children:[e.jsx("strong",{children:"How to enable camera:"}),e.jsx("br",{}),"1. Click the camera icon in your browser's address bar",e.jsx("br",{}),'2. Select "Allow" for camera access',e.jsx("br",{}),'3. Refresh the page or tap "Try Again"']})})]})})})},q=({image:s,isAnalyzing:t,onRetake:l,onAnalyze:o})=>e.jsxs(e.Fragment,{children:[e.jsx(k.img,{src:s,alt:"Captured plant",className:"absolute inset-0 w-full h-full object-cover z-10",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0}}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-8 safe-area-bottom z-20",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-6",children:[e.jsx(h,{onClick:l,variant:"secondary",disabled:t,children:"Retake"}),e.jsx(h,{onClick:o,disabled:t,children:t?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Analyzing..."})]}):"Add Plant"})]}),t&&e.jsx("p",{className:"text-center text-white mt-4 text-sm",children:"AI is identifying your plant and creating a care profile..."})]})]}),O=({videoRef:s,canvasRef:t,flashEnabled:l,onCapture:o,onSwitchCamera:p,onToggleFlash:x,onSelectFromGallery:u})=>{const j=z();return e.jsxs(e.Fragment,{children:[e.jsx(k.video,{ref:s,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover",initial:{opacity:0},animate:{opacity:1},transition:{duration:.5}}),e.jsx("canvas",{ref:t,className:"hidden"}),e.jsx("div",{className:"absolute top-0 left-0 right-0 p-4 safe-area-top z-20",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(h,{onClick:()=>j("/"),variant:"ghost",size:"icon",className:"rounded-full bg-black/50",children:e.jsx(F,{size:20})}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(h,{onClick:x,variant:"ghost",size:"icon",className:`rounded-full ${l?"bg-yellow-500 text-black hover:bg-yellow-600":"bg-black/50"}`,children:l?e.jsx(L,{size:20}):e.jsx(B,{size:20})}),e.jsx(h,{onClick:p,variant:"ghost",size:"icon",className:"rounded-full bg-black/50",children:e.jsx(U,{size:20})})]})]})}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-8 safe-area-bottom z-20",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-8",children:[e.jsx(h,{onClick:u,size:"icon",variant:"ghost",className:"w-14 h-14 rounded-full bg-black/50",children:e.jsx(M,{size:24})}),e.jsx(k.button,{onClick:o,className:"w-20 h-20 rounded-full bg-white border-4 border-gray-300 flex items-center justify-center ios-button",whileHover:{scale:1.05},whileTap:{scale:.95},children:e.jsx("div",{className:"w-16 h-16 rounded-full bg-white flex items-center justify-center",children:e.jsx(D,{size:24,className:"text-gray-600"})})}),e.jsx("div",{className:"w-14 h-14"})]}),e.jsx("p",{className:"text-center text-white mt-4 text-sm",children:"Position your plant in the frame and tap to capture, or select from gallery"})]}),e.jsx("div",{className:"absolute inset-0 pointer-events-none flex items-center justify-center",children:e.jsx("div",{className:"w-64 h-64 border-2 border-white/50 rounded-2xl"})})]})},J=()=>{const s=z(),{createPlant:t,isCreatingPlant:l}=G(),o=r.useRef(null),p=r.useRef(null),{isCapturing:x,capturedImage:u,cameraError:j,captureImage:y,retakePhoto:b,switchCamera:n,startCamera:g,selectFromGallery:C}=H({videoRef:o,canvasRef:p}),[N,E]=r.useState(!1),w=r.useRef(null),a=()=>{if(!u)return;const c="Interior",m=new Promise((d,S)=>{t({imageDataUrl:u,location:c},{onSuccess:f=>{f!=null&&f.id?s(`/plant/${f.id}`):s("/"),d(f)},onError:f=>{S(f)}})});T.promise(m,{loading:"Analizando imagen... La IA está trabajando.",success:d=>`¡Planta "${d.name}" creada con éxito!`,error:d=>`Error: ${d.message}`})},i=()=>E(c=>!c),v=c=>{var d;const m=(d=c.target.files)==null?void 0:d[0];m&&C(m)};return e.jsxs("div",{className:"fixed inset-0 bg-black z-50",children:[e.jsx("input",{ref:w,type:"file",accept:"image/*",onChange:v,className:"hidden",id:"gallery-input"}),e.jsx(P,{mode:"wait",children:j?e.jsx($,{error:j,onRetry:g},"error"):x?e.jsx(q,{image:u,isAnalyzing:l,onRetake:b,onAnalyze:a},"preview"):e.jsx(O,{videoRef:o,canvasRef:p,flashEnabled:N,onCapture:y,onSwitchCamera:n,onToggleFlash:i,onSelectFromGallery:()=>{var c;return(c=w.current)==null?void 0:c.click()}},"capture")})]})};export{J as default};
