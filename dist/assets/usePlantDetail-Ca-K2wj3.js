import{u as y}from"./useQuery-CKf0z--A.js";import{E as m,r as g,ab as D}from"./index-S10IpQsS.js";import{r as u,t as d,g as p}from"./index-DYDrsITg.js";function h(a){u(1,arguments);var e=d(a);return e.setHours(0,0,0,0),e}var _=864e5;function w(a,e){u(2,arguments);var n=h(a),t=h(e),r=n.getTime()-p(n),l=t.getTime()-p(t);return Math.round((r-l)/_)}function v(a,e){var n=a.getFullYear()-e.getFullYear()||a.getMonth()-e.getMonth()||a.getDate()-e.getDate()||a.getHours()-e.getHours()||a.getMinutes()-e.getMinutes()||a.getSeconds()-e.getSeconds()||a.getMilliseconds()-e.getMilliseconds();return n<0?-1:n>0?1:n}function P(a,e){u(2,arguments);var n=d(a),t=d(e),r=v(n,t),l=Math.abs(w(n,t));n.setDate(n.getDate()-r*l);var c=+(v(n,t)===-r),i=r*(l-c);return i===0?0:i}const M=async a=>{const{data:e,error:n}=await D.from("plants").select(`
      *,
      plant_images(*)
    `).eq("id",a).single();if(n)throw console.error(`Error fetching plant ${a}:`,n),n.code==="PGRST116"?new Error("Planta no encontrada."):new Error("Error al cargar la información de la planta.");const t=e;return{id:t.id,name:t.name,species:t.species,description:t.description??void 0,funFacts:t.fun_facts??void 0,variety:t.variety??void 0,nickname:t.nickname??void 0,location:t.location,plantEnvironment:t.plant_environment,lightRequirements:t.light_requirements,dateAdded:new Date(t.date_added),lastWatered:t.last_watered?new Date(t.last_watered):void 0,lastFertilized:t.last_fertilized?new Date(t.last_fertilized):void 0,healthScore:t.health_score??0,careProfile:t.care_profile,personality:t.personality,images:t.plant_images.map(r=>({id:r.id,url:r.url??"",timestamp:new Date(r.created_at),isProfileImage:r.is_profile_image??!1,healthAnalysis:r.health_analysis})),chatHistory:[],notifications:[]}},q=a=>{const{data:e,isLoading:n,error:t}=y({queryKey:["plant",a],queryFn:()=>M(a),enabled:!!a}),r=m(i=>i.setPlant),l=m(i=>i.selectPlant);g.useEffect(()=>(e&&(r(e),l(e.id)),()=>{l(null)}),[e,r,l]);const c=g.useMemo(()=>{if(!e)return[];const i=[];if(!e.images||e.images.length===0)return i;const f=e.images.map(s=>{var o;return((o=s.healthAnalysis)==null?void 0:o.confidence)||null}).filter(s=>s!==null);if(f.length>=3){const s=f.slice(-3);if(s[0]>s[1]&&s[1]>s[2]){const o=s[0]-s[2];i.push({type:"warning",title:"Tendencia de Salud a la Baja",message:`La salud de tu planta ha disminuido un ${o.toFixed(0)}% en las últimas revisiones.`})}}if(e.lastWatered&&e.careProfile){const s=P(new Date,new Date(e.lastWatered)),o=e.careProfile.wateringFrequency;s>o&&i.push({type:"tip",title:"Consejo de Riego",message:`Han pasado ${s} días desde el último riego. El intervalo recomendado es de ${o} días.`})}return i},[e]);return{plant:e,insights:c,loading:n,error:(t==null?void 0:t.message)||null}};export{q as u};
